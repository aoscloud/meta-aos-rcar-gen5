desc: "Aos development setup for Renesas RCAR Gen5 hardware"
min_ver: "0.1"

variables:
  # Build dirs

  YOCTOS_WORK_DIR: "yocto"
  BUILD_DIR: "build"

  # Machine
  # X5H is base on S4, and there is no public machine for X5H
  MACHINE: "spider"
  SOC_FAMILY: "r8a779f0"

  # Aos config
  AOS_UNIT_MODEL: "x5h"
  AOS_UNIT_VERSION: "1.0"

  AOS_BUNDLE_IMAGE_VERSION: "2.0.1"
  AOS_UM_COMPONENT_PREFIX: "%{AOS_UNIT_MODEL}-%{AOS_UNIT_VERSION}-%{MACHINE}-"

  AOS_BASE_IMAGE: "x5h-node0"

common_data:
  # Sources used by all yocto-based domains
  sources: &COMMON_SOURCES
    - type: git
      url: "https://git.yoctoproject.org/poky"
      rev: "59077aa77b17ca6fdcc4e66d9d8b0c18dc89ecce"

    - type: git
      url: "https://git.openembedded.org/meta-openembedded"
      rev: "79a6f60dabad9e5b0e041efa91379447ef030482"

    - type: git
      url: "https://git.yoctoproject.org/meta-virtualization"
      rev: "88327090d26955a678c6f8bd2585aad4d802f6c4"

    - type: git
      url: "https://github.com/aoscloud/meta-aos"
      rev: "29aa6aa47c2f5a3559ef4df36507c5bc2619704a"

    - type: git
      url: "https://github.com/renesas-rcar/meta-renesas.git"
      rev: "f669cd36bd9dbdec6d8d9a85d5ca164180973706"

    - type: git
      url: "https://github.com/longtruongrvc/meta-aos-rcar-gen5"
      rev: "020d4b003fb566758fd46ce0f3815d3b1dcd2691"

  # Common configuration options for all yocto-based domains
  common_conf: &COMMON_CONF
    - [SSTATE_DIR, "${TOPDIR}/../../../common_data/sstate"]
    - [DL_DIR, "${TOPDIR}/../../../common_data/downloads"]

    # Skip warning about missing "virtualization" distro feature
    - [SKIP_META_VIRT_SANITY_CHECK, "1"]

    - [MACHINE, "%{MACHINE}"]
    - [SOC_FAMILY, "%{SOC_FAMILY}"]

    # Init manager
    - [INIT_MANAGER, "systemd"]

    # Make logs persistent
    - [VOLATILE_LOG_DIR, "no"]

    # Generate ext4 image files
    - [IMAGE_FSTYPES:append, " ext4"]

    # Initramfs configuration
    - [INITRAMFS_IMAGE, "aos-image-initramfs"]
    - [INITRAMFS_IMAGE_BUNDLE, "0"]
    - [INITRAMFS_FSTYPES, "cpio.gz"]


    # Distro features

    # Remove features that we are not using
    - [
        DISTRO_FEATURES:remove,
        "x11 gtk gobject-introspection-data wifi nfc
        bluetooth irda zeroconf 3g sysvinit acl alsa argp pcmcia usbgadget
        usbhost opengl ptest multiarch wayland vulkan sysvinit",
      ]

    # Remove ptest to reduce the build time
    - [DISTRO_FEATURES:remove, "ptest"]

    # Machine features

    # Aos configuration

    - [AOS_UNIT_MODEL, "%{AOS_UNIT_MODEL}"]
    - [AOS_UNIT_VERSION, "%{AOS_UNIT_VERSION}"]
    - [AOS_UM_COMPONENT_PREFIX, "%{AOS_UM_COMPONENT_PREFIX}"]

    # Image versions
    - [AOS_ROOTFS_IMAGE_VERSION, "%{AOS_BUNDLE_IMAGE_VERSION}"]
    - [AOS_BOOT_IMAGE_VERSION, "%{AOS_BUNDLE_IMAGE_VERSION}"]

components:
  x5h:
    default: true
    build-dir: "%{YOCTOS_WORK_DIR}"
    sources:
      - *COMMON_SOURCES

    builder:
      type: yocto
      work_dir: "%{BUILD_DIR}"
      conf:
        - *COMMON_CONF

        # Requires to properly generate Aos FOTA
        - [IMAGE_BASENAME, "%{AOS_BASE_IMAGE}"]
        
        # Increase size for /root
        - [IMAGE_ROOTFS_EXTRA_SPACE, "1024288"]

        # Install modules
        - [CORE_IMAGE_EXTRA_INSTALL:append, " kernel-modules"]

        - [PREFERRED_PROVIDER_virtual/runc, "runc-opencontainers"]
        - [BBMASK:append,  " meta-aos/recipes-security"]

      build_target: "rcar-image-minimal"
      layers:
        - "../poky/meta"
        - "../poky/meta-poky"
        - "../poky/meta-yocto-bsp"
        - "../meta-virtualization"
        - "../meta-openembedded/meta-oe"
        - "../meta-openembedded/meta-networking"
        - "../meta-openembedded/meta-perl"
        - "../meta-openembedded/meta-python"
        - "../meta-openembedded/meta-filesystems"
        - "../meta-aos"
        - "../meta-renesas/meta-rcar-gateway"
        - "../meta-aos-rcar-gen5"

      target_images:
        - "tmp/deploy/images/%{MACHINE}/Image-%{MACHINE}.bin"
        - "tmp/deploy/images/%{MACHINE}/rootfs.cpio.gz"
        - "tmp/deploy/images/%{MACHINE}/%{AOS_BASE_IMAGE}-%{MACHINE}.ext4"
        - "tmp/deploy/images/%{MACHINE}/aos/boot/version"
        # firmware
        - "tmp/deploy/images/%{MACHINE}/bl31-%{MACHINE}.bin"
        - "tmp/deploy/images/%{MACHINE}/bl31-%{MACHINE}.srec"
        - "tmp/deploy/images/%{MACHINE}/tee-%{MACHINE}.bin"
        - "tmp/deploy/images/%{MACHINE}/tee-%{MACHINE}.srec"
        - "tmp/deploy/images/%{MACHINE}/u-boot-elf-%{MACHINE}.srec"
        - "tmp/deploy/images/%{MACHINE}/u-boot-%{MACHINE}.bin"

  pack-ipl:
    build-dir: "."
    builder:
      type: archive
      base_dir: "%{YOCTOS_WORK_DIR}/%{BUILD_DIR}/tmp/deploy/images/%{MACHINE}"
      name: "output/ipl/ipl-%{MACHINE}.tar.bz2"
      items:
        - "bl31-%{MACHINE}.bin"
        - "bl31-%{MACHINE}.srec"
        - "tee-%{MACHINE}.bin"
        - "tee-%{MACHINE}.srec"
        - "u-boot-elf-%{MACHINE}.srec"
        - "u-boot-%{MACHINE}.bin"

  fota:
    builder:
      type: custom_script
      work_dir: "fota"
      script: "yocto/meta-aos/scripts/fota_builder.py"
      args: "-v"
      target_images:
        - "output/fota/%{AOS_UM_COMPONENT_PREFIX}%{AOS_BUNDLE_IMAGE_VERSION}.tar"

      additional_deps:
        - "%{YOCTOS_WORK_DIR}/%{BUILD_DIR}/tmp/deploy/images/%{MACHINE}/Image-%{MACHINE}.bin"
        - "%{YOCTOS_WORK_DIR}/%{BUILD_DIR}/tmp/deploy/images/%{MACHINE}/rootfs.cpio.gz"
        - "%{YOCTOS_WORK_DIR}/%{BUILD_DIR}/tmp/deploy/images/%{MACHINE}/aos/boot/version"

      components:
        rootfs-full:
          componentType: "%{AOS_UM_COMPONENT_PREFIX}rootfs"
          enabled: true
          method: "overlay"
          yocto_dir: "%{YOCTOS_WORK_DIR}"
          build_dir: "%{BUILD_DIR}"
          type: "full"
          description: "x5h rootfs image"
          vendorVersion: "%{AOS_BUNDLE_IMAGE_VERSION}"
          exclude:
            - "var/*"
          fileName: "%{AOS_UM_COMPONENT_PREFIX}rootfs-full-%{AOS_BUNDLE_IMAGE_VERSION}.squashfs"

parameters:
  # Aos VIS data provider
  VIS_DATA_PROVIDER:
    desc: "Specifies plugin for VIS automotive data"
    renesassimulator:
      default: true
      overrides:
        variables:
          AOS_VIS_DATA_PROVIDER: "renesassimulatoradapter"

    telemetryemulator:
      overrides:
        variables:
          AOS_VIS_DATA_PROVIDER: "telemetryemulatoradapter"

  NODE_TYPE:
    desc: "Node type to build"
    "single":
      default: true
      overrides:
        components:
          x5h:
            builder:
              conf:
                - [AOS_HOSTS, "127.0.0.1=wwwivi"]
                - [AOS_VIS_DATA_PROVIDER, "%{AOS_VIS_DATA_PROVIDER}"]

